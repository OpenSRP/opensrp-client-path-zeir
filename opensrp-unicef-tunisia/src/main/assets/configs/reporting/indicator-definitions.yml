indicators:
  - key: "at_birth_vaccines"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received particular vaccines"
    indicatorQuery: "SELECT vaccines.name,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) <= 1 THEN '0_24hrs'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= 2 AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= 59 THEN '2_59days'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END age,
                            count(*)
                     FROM vaccines
                              INNER JOIN ec_client
                                         ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY vaccines.name, age"
    expectedIndicators:
      - "index_1_at_birth_vaccines_bcg"
      - "index_2_at_birth_vaccines_bcg_2_59days"
      - "index_4_at_birth_vaccines_hep_b_0_0_24hrs"
      - "index_5_at_birth_vaccines_hep_b_0_2_59days"
      - "index_19_at_birth_vaccines_pcv_2_2_6mnths"
      - "index_20_at_birth_vaccines_pcv_2_7_11mnths"
      - "index_21_at_birth_vaccines_pcv_2_12_17mnths"
      - "index_22_at_birth_vaccines_pcv_2_18_23mnths"
      - "index_23_at_birth_vaccines_pcv_2_24_59mnths"
      - "index_31_at_birth_vaccines_pcv_3_7_11mnths"
      - "index_32_at_birth_vaccines_pcv_3_12_17mnths"
      - "index_33_at_birth_vaccines_pcv_3_18_23mnths"
      - "index_34_at_birth_vaccines_pcv_3_24_59mnths"
      - "index_36_at_birth_vaccines_mr_1_12_17mnths"
      - "index_37_at_birth_vaccines_mr_1_18_23mnths"
      - "index_38_at_birth_vaccines_mr_1_24_59mnths"
      - "index_40_at_birth_vaccines_mr_2_18_23mnths"
      - "index_41_at_birth_vaccines_mr_2_24_59mnths"
      - "index_43_at_birth_vaccines_dtp_4_18_23mnths"
      - "index_44_at_birth_vaccines_dtp_4_24_59mnths"

  - key: "penta1_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_1, pcv_1 and penta_1 vaccines"
    indicatorQuery: "SELECT 'penta1'                                                                                         as penta1,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'ipv_1' OR vaccines.name = 'penta_1' OR vaccines.name = 'pcv_1')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age"
    expectedIndicators:
      - "index_7_penta1_grp_penta1_2_6mnths"
      - "index_8_penta1_grp_penta1_7_11mnths"
      - "index_9_penta1_grp_penta1_12_17mnths"
      - "index_10_penta1_grp_penta1_18_23mnths"
      - "index_11_penta1_grp_penta1_24_59mnths"

  - key: "penta2_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_2 and penta_2 vaccines"
    indicatorQuery: "SELECT 'penta2'                                                                                         as penta2,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'ipv_2' OR vaccines.name = 'penta_2')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age;"
    expectedIndicators:
      - "index_13_penta2_grp_penta2_2_6mnths"
      - "index_14_penta2_grp_penta2_7_11mnths"
      - "index_15_penta2_grp_penta2_12_17mnths"
      - "index_16_penta2_grp_penta2_18_23mnths"
      - "index_17_penta2_grp_penta2_24_59mnths"

  - key: "penta3_grp"
    isMultiResult: true
    grouping: "report_group_header_vaccination_activity"
    description: "Grouped query for number of children aged 0-59months who received ipv_1 and penta_3 vaccines"
    indicatorQuery: "SELECT 'penta3'                                                                                         as penta3,
                            CASE
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (2 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (6 * 30.436875) THEN '2_6mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (7 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (11 * 30.436875) THEN '7_11mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (12 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (17 * 30.436875) THEN '12_17mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (18 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (23 * 30.436875) THEN '18_23mnths'
                                WHEN round(julianday('now') - julianday(ec_client.dob)) >= (24 * 30.436875) AND
                                     round(julianday('now') - julianday(ec_client.dob)) <= (59 * 30.436875) THEN '24_59mnths'
                                ELSE 'Null'
                                END                                                                                             age,
                            (SELECT count(base_entity_id)
                             FROM (SELECT DISTINCT vaccines.base_entity_id
                                   FROM vaccines
                                            INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                   WHERE ec_client.is_closed != 1
                                     AND (vaccines.name = 'opv_1' OR vaccines.name = 'penta_3')
                                     AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))) as count
                     FROM vaccines
                              INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                     WHERE ec_client.is_closed != 1
                       AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')
                     GROUP BY age;"
    expectedIndicators:
      - "index_25_penta3_grp_penta3_2_6mnths"
      - "index_26_penta3_grp_penta3_7_11mnths"
      - "index_27_penta3_grp_penta3_12_17mnths"
      - "index_28_penta3_grp_penta3_18_23mnths"
      - "index_29_penta3_grp_penta3_24_59mnths"

  - key: "index_3_bcg_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received BCG vaccine at the facility"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'bcg'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_6_hepb_0_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Hep B 0 vaccine at the facility"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'hep_b_0'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_12_penta1_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta1, IPV1 and PCV1 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'ipv_1' OR vaccines.name = 'penta_1' OR vaccines.name = 'pcv_1')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))
"

  - key: "index_18_penta2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta2 and IPV2 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'penta_2' OR vaccines.name = 'ipv_2')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_24_pcv2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  PCV2  vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'pcv_2'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_30_penta3_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received Penta 3 and OPV1  vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM ec_client
                                    INNER JOIN vaccines ON ec_client.base_entity_id = vaccines.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND (vaccines.name = 'penta_3' OR vaccines.name = 'opv_1')
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_35_pcv3_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  PCV3 vaccines"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'pcv_3'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_39_mr1_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  MR1vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'mr_1'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_42_mr2_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received  MR2 vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'mr_2'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_45_dtp4_total"
    grouping: "report_group_header_vaccination_activity"
    description: "Total number of children of all ages who received DTP4 vaccine"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT vaccines.base_entity_id
                           FROM vaccines
                                    INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                           WHERE ec_client.is_closed != 1
                             AND vaccines.name = 'dtp_4'
                             AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime'))"

  - key: "index_46_vaccine_doses_administered"
    grouping: "report_group_header_vaccine_utilization"
    description: "Number of doses administered for each vaccine BCG,  OPV,  DTP,  MR,  Hep B,  Penta,  IPV, PCV, Rubella"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (SELECT DISTINCT base_entity_id
                           FROM (
                                    SELECT DISTINCT vaccines.base_entity_id
                                    FROM vaccines
                                             INNER JOIN ec_client ON vaccines.base_entity_id = ec_client.base_entity_id
                                    WHERE ec_client.is_closed != 1
                                      AND (vaccines.name = 'bcg' OR vaccines.name = 'opv_1' OR vaccines.name = 'opv_2'
                                        OR vaccines.name = 'dtp_4' OR vaccines.name = 'mr_1' OR vaccines.name = 'mr_2'
                                        OR vaccines.name = 'hep_b_0' OR vaccines.name = 'penta_1' OR vaccines.name = 'penta_2'
                                        OR vaccines.name = 'penta_3' OR vaccines.name = 'ipv_1' OR vaccines.name = 'ipv_2'
                                        OR vaccines.name = 'pcv_1' OR vaccines.name = 'pcv_2' OR vaccines.name = 'pcv_3'
                                        OR vaccines.name = 'pcv_4')
                                      AND strftime('%Y-%m-%d', '%s') = date(vaccines.date / 1000, 'unixepoch', 'localtime')

                                    UNION ALL
                                    SELECT DISTINCT ec_child_details.base_entity_id
                                    FROM ec_child_details
                                             INNER JOIN ec_mother_details
                                                        ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                                    WHERE date_removed IS NULL
                                      AND ec_mother_details.mother_rubella = 'yes' COLLATE NOCASE
                                      AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                                ))"

  - key: "index_52_PAB_mother_dt"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus at birth, through the tetanus vaccine received by the mother during pregnancy (mother dT) only."
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'yes' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS NOT 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"

  - key: "index_53_PAB_assisted_delivery"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus through assisted delivery only "
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'no' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"

  - key: "index_54_PAB_dt_and_assisted_delivery"
    grouping: "report_group_header_tetanus_protected"
    description: "Month to month visual of the number of  children that are protected against tetanus at birth, through the tetanus vaccine received by the mother during pregnancy (mother dT) and assisted delivery"
    indicatorQuery: "SELECT count(base_entity_id)
                     FROM (
                              SELECT DISTINCT ec_child_details.base_entity_id
                              FROM ec_child_details
                                       INNER JOIN ec_mother_details
                                                  ON ec_child_details.relational_id = ec_mother_details.base_entity_id
                              WHERE date_removed IS NULL
                                AND ec_mother_details.protected_at_birth = 'yes' COLLATE NOCASE
                                AND ec_child_details.place_of_birth IS 'hospital' COLLATE NOCASE
                                AND strftime('%Y-%m-%d', '%s') = strftime('%Y-%m-%d', ec_mother_details.date)
                          )"